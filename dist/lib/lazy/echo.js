!function(root,factory){"function"==typeof define&&define.amd?define(function(){return factory(root)}):"object"==typeof exports?module.exports=factory:root.echo=factory(root)}(this,function(root){"use strict";var offset,poll,delay,useDebounce,unload,container,echo={},callback=function(){},inView=function(element,view){if(function(element){return null===element.offsetParent}(element))return!1;var box=element.getBoundingClientRect();return box.right>=view.l&&box.bottom>=view.t&&box.left<=view.r&&box.top<=view.b},debounceOrThrottle=function(){!useDebounce&&poll||(clearTimeout(poll),poll=setTimeout(function(){echo.render(),poll=null},delay))};return echo.init=function(opts){container=(opts=opts||{}).container||root;var offsetAll=opts.offset||0,offsetVertical=opts.offsetVertical||offsetAll,offsetHorizontal=opts.offsetHorizontal||offsetAll,optionToInt=function(opt,fallback){return parseInt(opt||fallback,10)};offset={t:optionToInt(opts.offsetTop,offsetVertical),b:optionToInt(opts.offsetBottom,offsetVertical),l:optionToInt(opts.offsetLeft,offsetHorizontal),r:optionToInt(opts.offsetRight,offsetHorizontal)},delay=optionToInt(opts.throttle,250),useDebounce=!1!==opts.debounce,unload=!!opts.unload,callback=opts.callback||callback,echo.render(),document.addEventListener?(container.addEventListener("scroll",debounceOrThrottle,!1),container.addEventListener("load",debounceOrThrottle,!1)):(container.attachEvent("onscroll",debounceOrThrottle),container.attachEvent("onload",debounceOrThrottle))},echo.render=function(context){for(var src,elem,nodes=(context||document).querySelectorAll("[data-echo], [data-echo-background]"),length=nodes.length,view={l:0-offset.l,t:0-offset.t,b:(root.innerHeight||document.documentElement.clientHeight)+offset.b,r:(root.innerWidth||document.documentElement.clientWidth)+offset.r},i=0;i<length;i++)elem=nodes[i],inView(elem,view)?(unload&&elem.setAttribute("data-echo-placeholder",elem.src),null!==elem.getAttribute("data-echo-background")?elem.style.backgroundImage="url("+elem.getAttribute("data-echo-background")+")":elem.src!==(src=elem.getAttribute("data-echo"))&&function(src,elem){var img=new Image;img.src=src,img.onload=function(){elem.src=src}}(src,elem),unload||(elem.removeAttribute("data-echo"),elem.removeAttribute("data-echo-background")),callback(elem,"load")):unload&&(src=elem.getAttribute("data-echo-placeholder"))&&(null!==elem.getAttribute("data-echo-background")?elem.style.backgroundImage="url("+src+")":elem.src=src,elem.removeAttribute("data-echo-placeholder"),callback(elem,"unload"));length||echo.detach()},echo.detach=function(){document.removeEventListener?container.removeEventListener("scroll",debounceOrThrottle):container.detachEvent("onscroll",debounceOrThrottle),clearTimeout(poll)},echo});