var menu=new FlMenu,mobileListData=new MobileListData({url:PublicUrl.deviceListUrl(),data:{onlineState:$("#mornitor-eqstate").val(),type:$("#mornitor-eqstate").val(),languageType:Public.languageType,devName:$("#mornitor-searcheq").val(),startTime:$("#datetime-start").val(),endTime:$("#datetime-end").val(),equipType:JSON.stringify([])},listObj:"#mornitor-list-data",getListHtml:getListHtml}),pageEqInit=!1,treeMap=null,treeEq=null,$document=$(document),searchDateObj=null,BaiduMap={map:null,markerClusterer:null,carDataArr:[],carMarkarr:[],init:function(){var self=this,geolocation=new BMap.Geolocation;gc=new BMap.Geocoder,self.map=new BMap.Map("baiduMapView"),self.map.enableScrollWheelZoom(!0),geolocation.getCurrentPosition(function(r){if(this.getStatus()==BMAP_STATUS_SUCCESS){var pt=r.point;gc.getLocation(pt,function(rs){var addComp=rs.addressComponents;Public.toast(addComp.city),self.map.centerAndZoom(addComp.city,14)})}else switch(this.getStatus()){case 2:Public.toast("获取位置失败.");break;case 3:Public.toast("获取位置失败..");break;case 4:case 5:Public.toast("获取位置失败.");break;case 6:Public.toast("对不起,当前 没有权限 获取位置失败.");break;case 7:Public.toast("对不起,服务不可用 获取位置失败.");break;case 8:Public.toast("对不起,请求超时 获取位置失败.")}},{enableHighAccuracy:!0})},setMapCenter:function(points){},addMarkers:function(){var marker=this.carMarkarr,getmapBound=this.map.getBounds();for(i=0,len=marker.length;i<len;i++){var mPoint=marker[i].point;BMapLib.GeoUtils.isPointInRect(mPoint,getmapBound);this.map.addOverlay(marker[i]);var label=new BMap.Label(marker[i].devName,{offset:new BMap.Size(-20,-20)});label.setStyle({backgroundColor:"#ffffff",backgroundPosition:"0 0",backgroundSize:"cover",padding:"0px 5px",border:"1px solid #dddddd",borderRadius:"5px",boxShadow:"0px 0px 4px 0px #7b7b7b",fontSize:"12px",border:"none",width:"auto",height:"25px",lineHeight:"25px",textAlign:"center"}),marker[i].setLabel(label),function(i){var thePoint=marker[i];thePoint.addEventListener("click",function(){var devCode=thePoint.devCode,devMac=(thePoint.devEquipmentType,thePoint.devMac),devName=thePoint.devName,state=thePoint.state;$("#eq-state").addClass(Public.leaveLineStyle(state)),$("#eq-state").text(Public.leaveLineName(state)),$("#eq-devCode").text(devCode),$("#eq-mac").text(devMac),$("#eq-name").text(devName),Public.popup(".popup-map-eq")})}(i)}}};function getListHtml(data){for(var shtml="",allChecked=$("#checkAll").prop("checked"),i=0,len=data.length;i<len;i++){var itemData=data[i],devId=itemData.devId,devName=itemData.devName,devCode=itemData.devCode,devMac=itemData.devMac,lastOnlineDate=Public.leaveLine(itemData.lastOnlineDate),groupName=itemData.groupName,devEquipmentType=itemData.devEquipmentType,updateDate=Public.momentFormat(itemData.updateDate,"YYYY-MM-DD HH:mm:ss"),classStyle=Public.leaveLineStyle(lastOnlineDate),lineName=Public.leaveLineName(lastOnlineDate),imgSrc=PublicUrl.imgSrc();shtml+='<div class="col-50"><div class="item '+classStyle+'"><div class="label-checked-box pull-left"><input type="checkbox" '+(allChecked?"checked":"")+' id="check-'+devId+'" value="'+devId+'" /><label for="check-'+devId+'"></label></div><div class="eq-type">'+(devEquipmentType=Public.isEqType(devEquipmentType))+'</div><div class="item-in"><div class="pic"><img src="'+imgSrc+Public.getEqImage(devEquipmentType)+'" alt=""><div class="icon"><span class="iconfont icon-yijianjieping eq-control" data-devid="'+devId+'" data-sendtype="110"></span><span class="iconfont icon-kaibo eq-control" data-devid="'+devId+'" data-sendtype="180"></span><span class="iconfont icon-stop-playing eq-control" data-devid="'+devId+'" data-sendtype="190"></span><span class="iconfont icon-jiaocha eq-signal" data-devid="'+devId+'" style="display:'+("VP1000U"===devEquipmentType||"VP-U"===devEquipmentType?"inline-block":"none")+'"></span></div></div><div class="info"><div class="name">'+devName+' </div><div class="row"><div class="col-100"><span class="iconStyle"><i class="iconfont icon-icon-"></i></span><span class="line">'+lineName+'</span></div></div><div class="row"><div class="col-100"><span class="iconStyle"><i class="iconfont icon-none"></i></span><span class="no">'+devCode+'</span></div></div><div class="row"><div class="col-100"><span class="iconStyle"><i class="iconfont icon-MAC"></i></span><span class="mac">'+devMac+'</span></div></div><div class="row"><div class="col-100"><span class="iconStyle"><i class="iconfont icon-fenzu"></i></span><span class="date text-hide">'+groupName+'</span></div></div><div class="row"><div class="col-100"><span class="iconStyle"><i class="iconfont icon-shijian"></i></span><span class="date">'+updateDate+'</span></div></div><div class="row"><div class="col-100"><a href="screenshot.html?devId='+devId+"&devName="+devName+'" class="button button-light" external>截屏信息</a></div></div></div> </div></div></div>'}return shtml}function refreshData(){var eqstate=$("#mornitor-eqstate").val(),eqtype=""===$("#multi-select").attr("data-items")||null===$("#multi-select").attr("data-items")?[]:$("#multi-select").attr("data-items").split(","),devName=$("#mornitor-searcheq").val(),starTime=$("#datetime-start").val(),endTime=$("#datetime-end").val(),paramData=getAllChecked(treeEq),gid=JSON.stringify(paramData.gid),pid=JSON.stringify(paramData.pid),did=JSON.stringify(paramData.did),param={onlineState:eqstate,type:eqstate,languageType:Public.languageType,devName:devName,startTime:starTime,endTime:endTime};eqtype=JSON.stringify(eqtype),Public.isArry(gid)&&(param.gid=gid),Public.isArry(pid)&&(param.pid=pid),Public.isArry(did)&&(param.did=did),param.equipType=eqtype,mobileListData.options.data=param,mobileListData.options.initData=!0,mobileListData.init(),$("#mornitor-submit").removeAttr("disabled")}function getAllChecked(tree){for(var allChecked=tree.getAllChecked().split(","),gid=[],pid=[],did=[],i=0,len=allChecked.length;i<len;i++){var id=allChecked[i];tree.getUserData(id,"isParent")?1===tree.getOpenState(id)?gid.push(id):pid.push(id):""!==id&&did.push(id)}return{gid:gid,pid:pid,did:did}}function deleteEq(itemId){Public.ajaxCall({type:"DELETE",url:PublicUrl.deviceOneUrl()+itemId,successCallBack:function(data){Public.toast(data.response),setTimeout(function(){refreshData()},800)}})}function sendEqControl(type,param){Public.ajaxCall({type:"POST",url:PublicUrl.sendPlayTaskUrl()+type,data:param,successCallBack:function(data){Public.toast(data.response)}})}function getSignal(a){switch(a){case"1":return"0x02";case"2":return"0x03";case"3":return"0x01";case"4":return"0x04";case"5":return"0x05";case"9":return"0x07";case"7":return"0x06";case"8":return"0x08";default:return"0x09"}}function getSignalBack(a){switch(a){case"HDMI":return"2";case"VGA":return"3";case"CV1":return"4";case"CV2":return"5";case"DP":return"7";case"DVI":return"1";case"SDI":case"USB":return"8";default:return"1"}}function singleAlready(did){Public.showPreloader("数据回读中..."),Public.ajaxCall({type:"POST",url:PublicUrl.deviceTaskUrl()+277,data:{did:did},successCallBack:function(data){0<data.code?Public.ajaxCall({type:"GET",url:PublicUrl.singleAreadyUrl(),data:{did:did,taskType:277},successCallBack:function(data){if(Public.hidePreloader(),0<data.code&&data.response){var jsonStr=data.response.content,dataJson=JSON.parse(jsonStr),changeSourceIn=dataJson.changeSourceIn[0],screenAll=dataJson.screenAll[0],brightness=dataJson.brightness[0],freeze=dataJson.freeze.value,screenBlack=dataJson.screenBlack.value,pip=dataJson.pip.value,$freezeSwitch=$("#freeze-switch"),$pipSwicth=$("#pip-switch");$("#signal-screenWin").attr("data-json",JSON.stringify(dataJson.changeSourceIn)).val(changeSourceIn.screenWin),$("#signal-sourc").val(getSignalBack(changeSourceIn.value)),$("#signal-local-win").attr("data-json",JSON.stringify(dataJson.screenAll)).val(screenAll.screenWin),$("#signal-local").val(1==screenAll.value?0:1),brightness?($("#range-value").val(brightness.value),$(".range").customSlider({initVal:brightness.value}),$("#signal-light-win").attr("data-json",JSON.stringify(dataJson.brightness)).val(brightness.screenWin)):$(".range").customSlider({initVal:0}),0==freeze?$freezeSwitch.prop("checked",!1):$freezeSwitch.prop("checked",!0),$("#signal-screen").val(screenBlack),0==pip?$pipSwicth.prop("checked",!1):$pipSwicth.prop("checked",!0)}else data.response?Public.toast(data.response):null==data.response&&Public.customToast("暂无数据！")}}):data.response?Public.customToast(data.response):null==data.response&&Public.customToast("暂无数据！")}})}$(function(){Public.showPreloader("加载中..."),$.init(),menu.init(),mobileListData.init(),(treeEq=Public.dhtmlxTreeGroup()).attachEvent("onCheck",function(id,state){refreshData()}),Public.datetimePicker({obj:"#datetime-start, #datetime-end",format:"YYYY-MM-DD"}),$(document).on("pageInit","#routers-map",function(e,pageId,$page){BaiduMap.init(),$("#float-menu-map").hide(),$("#float-menu-eq").show()}),$(document).on("pageInit","#routers-equipment",function(e,pageId,$page){$("#float-menu-map").show(),$("#float-menu-eq").hide()}),$(document).on("click","#map-popup",function(){Public.popup(".popup-map"),null===treeMap&&(treeMap=Public.dhtmlxTreeEqGroup()).attachEvent("onCheck",function(id,state){var paramData=getAllChecked(treeMap),gid=JSON.stringify(paramData.gid),pid=JSON.stringify(paramData.pid),did=JSON.stringify(paramData.did);Public.ajaxCall({type:"GET",url:PublicUrl.deviceListUrl(),data:{languageType:Public.languageType,pid:pid,gid:gid,did:did},successCallBack:function(data){var dataLists=data.response.list,dataLen=dataLists.length;if(0!==dataLen){for(var i=0;i<dataLen;i++){var iconStyle,lat=dataLists[i].devLatitudeValue,lng=dataLists[i].devLongitudeValue,carState=dataLists[i].state,devName=dataLists[i].devName,devId=dataLists[i].devId,devMac=dataLists[i].devMac,devEquipmentType=dataLists[i].devEquipmentType,devCode=dataLists[i].devCode;iconStyle=1==carState?"./../images/icon-online.png":2==carState?"./../images/icon-offline.png":3==carState?"./../images/icon-fault.png":"./../images/icon-unknow.png";var myIcon=new BMap.Icon(iconStyle,new BMap.Size(20,30)),marker=new BMap.Marker(new BMap.Point(lng,lat),{icon:myIcon,enableMassClear:!0});marker.devName=devName,marker.state=state,marker.id=devId,marker.devMac=devMac,marker.devEquipmentType=devEquipmentType,marker.devCode=devCode,BaiduMap.carMarkarr.push(marker)}BaiduMap.addMarkers()}else Public.toast("暂无数据！")}})})}),$(document).on("click","#eq-popup",function(){Public.popup(".popup-eq")}),$(document).on("click","#search-popup",function(){Public.popup(".popup-search"),null===searchDateObj&&(searchDateObj=Public.datetimePicker({obj:"#map-beginTime,#map-endTime"}))}),$(document).on("click","#mornitor-submit",function(){var starTime=$("#datetime-start").val(),endTime=$("#datetime-end").val(),params={starDate:starTime,endDate:endTime};$("#mornitor-submit").attr("disabled","disabled"),Public.momentIsBefore(params)||Public.momentIsSame(params)||!Public.isDefine(starTime)&&!Public.isDefine(endTime)?(Public.closeModal(".popup-search"),refreshData()):($("#mornitor-submit").removeAttr("disabled"),Public.toast(locales.dateMoment))}),$(document).on("click",".eq-control",function(){var msg,$this=$(this),devid=$this.attr("data-devid"),sendtype=$this.attr("data-sendtype"),devidArr=[];devidArr.push(devid),msg=Public.isPramStatue(1*sendtype),Public.msuiConfirm("确定下发"+msg+"任务？",function(){var param={did:JSON.stringify(devidArr),content:""};sendEqControl(sendtype,param)})}),$(document).on("click",".eq-signal",function(){var devid=$(this).attr("data-devid"),did=[];did.push(devid),$(".popup-signal").attr("data-devid",devid),Public.popup(".popup-signal"),singleAlready(JSON.stringify(did))}),$(document).on("click","#signalAready",function(){var did=$(".popup-signal").attr("data-devid"),didArr=[];didArr.push(did),singleAlready(JSON.stringify(didArr))}),$(document).on("click",".signal-btn",function(){var flag=1*$(this).attr("data-flag"),windowOption=null,content={},devId=$(".popup-signal").attr("data-devid"),devidArr=[];devidArr.push(devId),801===flag?(windowOption=0==$("#signal-screenWin").val()?"0x00":"0x01",content={value:getSignal($("#signal-sourc").val()),param:windowOption}):804===flag?content={value:windowOption=0==(windowOption=$("#signal-local-win").val())?"0x00":1==windowOption?"0x01":2==windowOption?"0x02":"0x03",param:0==$("#signal-local").val()?"0x01":"0x00"}:810===flag?(windowOption=$("#signal-light-win").val(),content={value:$("#range-value").val(),adjustmentType:"0x01",windowNumber:windowOption}):802===flag?content={value:$("#freeze-switch").prop("checked")?"1":"0"}:803===flag?(content={value:$("#signal-screen").val()},console.log(content)):814===flag&&(content={value:$("#pip-switch").prop("checked")?"1":"0"});var params={did:JSON.stringify(devidArr),content:JSON.stringify(content)};Public.ajaxCall({type:"POST",url:PublicUrl.deviceTaskUrl()+flag,data:params,successCallBack:function(data){Public.customToast(data.response)}})}),$(document).on("click",".eq-delete",function(){for(var $checkboxList=$("#mornitor-list-data input:checked"),len=$checkboxList.length,checkboxIdArr=[],i=0;i<len;i++){var val=$($checkboxList[i]).val();checkboxIdArr.push(val)}0<len?Public.msuiConfirm("是否删除所选设备？",function(){deleteEq(checkboxIdArr)}):Public.toast(locales.promptChecked)}),$("#multi-select").multiSelect(),$("#signal-screenWin").on("change",function(){var dataJson=JSON.parse($(this).attr("data-json")),val=1*$(this).val();dataJson&&$("#signal-sourc").val(getSignalBack(dataJson[val].value))}),$("#signal-local-win").on("change",function(){var dataJson=JSON.parse($(this).attr("data-json")),val=1*$(this).val();dataJson&&$("#signal-local").val(1==dataJson[val].value?0:1)}),$("#signal-light-win").on("change",function(){var dataJson=JSON.parse($(this).attr("data-json")),val=1*$(this).val();dataJson&&$(".range").customSlider({initVal:dataJson[val].value})})});var HistoryRoute={_isOver:!0,_isPlay:!1,timerId:null,playSpeed:300,totalNum:0,markArryData:[],carMark:null,clearOverlayArr:[],mapZoom:0,routePlayTime:0,getMarkPoint:function(){var pointArry=[];this.nCount=0,this.nCountPage=0,this.totalNum=this.markArryData.length,this.stop(),this.claerMapData();for(var i=0;i<this.totalNum;i++)pointArry.push(new BMap.Point(this.markArryData[i].lng,this.markArryData[i].lat));this.drawRoute(pointArry),this.getViewport(pointArry),this.addMraker("images/icon_begin.png",60,60,this.markArryData[0]),this.removeDisabledBtn("#routeStop"),this.play()},getViewport:function(pointArry){var view=map.getViewport(pointArry);map.centerAndZoom(view.center,view.zoom),this.mapZoom=view.zoom},play:function(){var _this=this,speed=$("#sliderSpeedText").attr("data-speed"),nowTime=Date.parse(new Date);_this._isPlay||("0"===speed?_this.playSpeed=20:"1"===speed?_this.playSpeed=10:"2"===speed&&(_this.playSpeed=1),0!==_this.routePlayTime&&nowTime-_this.routePlayTime<1e3||(_this.removeDisabledBtn("#routePause"),_this.removeDisabledBtn("#routeStop"),_this.addDisabledBtn("#routePlay"),_this.timerId=window.setInterval(function(){_this._isOver=!1,_this.PlayWithRoute(),_this.routePlayTime=Date.parse(new Date)},_this.playSpeed)))},pause:function(){clearInterval(this.timerId),this.removeDisabledBtn("#routePlay"),this.addDisabledBtn("#routePause")},stop:function(){clearInterval(this.timerId),this.removeDisabledBtn("#routePlay"),this.nCount=0,this.addDisabledBtn("#routePause"),this.addDisabledBtn("#routeStop"),map.removeOverlay(this.carMark)},PlayWithRoute:function(){if(this.totalNum==this.nCount)return clearInterval(this.timerId),this._isOver=!0,hasAjax?(this.pause(),void pageLoading("#tabMapIn")):(this.nCount=0,map.removeOverlay(this.carMark),this.removeDisabledBtn("#routePlay"),void this.addDisabledBtn("#routeStop"));var record=this.markArryData[this.nCount],point=new BMap.Point(record.lng,record.lat);this.carMarkRun(point,record),this.nCount++},carMarkRun:function(point,record){var icon=new BMap.Icon("images/car.png",new BMap.Size(45,45)),marker=new BMap.Marker(point,{icon:icon}),html="<div><font>"+record.html+'</font></div><div><font style="color:#d70000">速度：'+Math.round(record.speed)+'</font></div><div><font style="color:#76da00">GPS：'+record.satellite+"</font></div>",label=new BMap.Label(html,{offset:new BMap.Size(-20,-80)});marker.setLabel(label),label.setStyle({fontSize:"14px",border:"1px solid #cdcdcd",borderRadius:"5px",padding:"0px 6px",lineHeight:"22px"}),this.carMark&&map.removeOverlay(this.carMark),(this.carMark=marker).setRotation(record.direction),map.addOverlay(marker),!0!==map.getBounds().containsPoint(point)&&map.centerAndZoom(point,this.mapZoom)},addMraker:function(img,sizeW,sizeH,markData){point=new BMap.Point(markData.lng,markData.lat),icon=new BMap.Icon(img,new BMap.Size(sizeW,sizeH)),marker=new BMap.Marker(point,{icon:icon}),label=new BMap.Label(GetDateTimeformat(markData.time,"yyyy-MM-dd HH:mm:ss"),{offset:new BMap.Size(55,5)}),marker.setLabel(label),label.setStyle({backgroundImage:"url(images/time_bg.png)",backgroundColor:"rgba(0,0,0,0)",backgroundPosition:"0 0",width:"142px",height:"27px",backgroundSize:"cover",border:"none",lineHeight:"27px",textAlign:"center"}),marker.setOffset(new BMap.Size(0,-30)),map.addOverlay(marker),this.clearOverlayArr.push(marker)},drawRoute:function(points){var polyline=new BMap.Polyline(points,{strokeColor:"#00c600",strokeWeight:4,strokeOpacity:1});map.addOverlay(polyline),this.clearOverlayArr.push(polyline)},addDisabledBtn:function(obj){$(obj).addClass("disabled")},removeDisabledBtn:function(obj){$(obj).removeClass("disabled")},claerMapData:function(){var overlayLen=this.clearOverlayArr.length;this.stop(),this.addDisabledBtn("#routePlay");for(var i=0;i<overlayLen;i++)map.removeOverlay(this.clearOverlayArr[i])},showInfo:function(thisMaker,point){var infoWindow=new BMap.InfoWindow('<ul class="baiduMapInfoWin"><li class="item"><span class="title">司机</span><span class="info">李某</span></li><li class="item"><span class="title">车牌</span><span class="info"> 粤S85585</span></li><li class="item"><span class="title">时间</span><span class="info"> 2017-02-05 15:20:20</span></li><li class="item"><span class="title">省市</span><span class="info"> 广东省深圳市宝安区</span></li><li class="item"><span class="title">道路</span><span class="info"> 石岩街道创维天桥创维数字</span></li><li class="item"><span class="title">附近</span><span class="info"> </span></li></ul>',{width:300,height:180,enableMessage:!1});thisMaker.openInfoWindow(infoWindow)}};