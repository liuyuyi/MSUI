var allPageResolution="",pargarmId=Public.getUrlItem(window.location.href).id,pargarmEq=Public.getUrlItem(window.location.href).eq,pargarmPageIndex=0,dragResize=null,serverData=null,menu=new FlMenu,editerDataStore=null,nowPageScriptPath="",pageNo=1,mediaType=1,mediaChooseType=0,listColor=["#434343","#666666","#b7b7b7","#980000","#ff0000","#ff9900","#ffff00","#00ffff","#0000ff","#9900ff","#ff00ff","#228b22","#008000","#87cefa"],nowPageId=Public.getUrlItem(window.location.href).pageId;function pageInit(){var editerData,shtml="";if(Editer_stage.tool.clearEditerAreaData(),editerData=(editerDataStore=new Editer_stage.editAreaData(serverData)).returnData(),Editer_stage.tool.intEditerAreaBg(editerData),Editer_stage.tool.setEditerAreaBg(),is_define(editerData.mediaEle)){picJsonId=[];for(var i=0,len=editerData.mediaEle.length;i<len;i++)shtml+=Editer_stage.tool.initEditareaItem(editerData.mediaEle[i])}Editer_stage.tool.addEditerAreaData(shtml),Editer_stage.tool.siderbuildEditerArea(50),(dragResize=new Editer_stage.dragResize({panel:$("#editerCanvas-wrap")[0],editerArea:$(".editerCanvas-main")[0],resolutionWidth:Editer_stage.tool.getProgramResolutionWidth(),resolutionHeight:Editer_stage.tool.getProgramResolutionHeight(),eventDown:"touchstart",eventUp:"touchend",eventMove:"touchmove"})).addMouseListener(),Editer_stage.tool.hideLoading()}function getJsPageInit(){Public.loadJs(nowPageScriptPath,function(){serverData=picDate,pageInit()})}function getMediaAjax(){Editer_stage.tool.showLoading("加载中..."),Public.ajaxCall({type:"GET",url:PublicUrl.materialListUrl()+mediaType,data:{isCommon:$("#isCommon").val(),name:$("#media-search").val(),pageNo:pageNo,pageSize:6},successCallBack:function(data){Editer_stage.tool.hideLoading();var shtml="";1===pageNo&&$("#media-list-data").empty();for(var i=0,len=data.response.list.length;i<len;i++)shtml+=getMediaHtml(data.response.list[i]);data.response.pageNum!==data.response.lastPage&&0<len?($(".more-media").show(),$(".no-more-media").hide()):($(".more-media").hide(),$(".no-more-media").show()),$("#media-list-data").append(shtml),echo.init({offset:200,container:document.getElementById("content-list"),callback:function(element,op){console.log(element,"has been",op+"ed")}}),setTimeout(function(){echo.render()},1e3)}})}function clickMore(){pageNo++,getMediaAjax()}function openMediaModal(){var titleName="";"1"===mediaType?titleName="图片素材":"2"===mediaType&&(titleName="视频素材"),$(".popup-title").text(titleName),getMediaAjax(),setTimeout(function(){$(".popup-media").addClass("silde-in").show()},800)}function closeMediaModal(){var $modal=$(".popup-media");$modal.addClass("silde-out").removeClass("silde-in"),pageNo=1,$("#isCommon").val(""),$("#media-search").val(""),$(".media-list").scrollTop(0),setTimeout(function(){$modal.removeClass("silde-out").hide()},300)}function getMediaHtml(data){var itemData=data,materialContentType=itemData.materialContentType,materialRelativePath=(itemData.materialTypeName,itemData.materialRelativePath),materialStorageName=itemData.materialStorageName,materialOriginalName=itemData.materialOriginalName,materialSize=(itemData.materialAuditStatus,itemData.createBy,itemData.createDate,itemData.materialLabel,Public.formatFileSize(itemData.materialSize)),materialId=(itemData.materialTypeId,itemData.materialId),materialHtml="",icon="",materialUrl=PublicUrl.materialResourceUrl()+materialRelativePath+materialStorageName;return materialContentType.match("image.*")?(materialHtml='<div class="picture" data-url="'+materialUrl+'"><img onerror="this.src=\'./../images/default.jpg\'" data-echo="'+materialUrl+'" src="./../images/default.jpg" alt=""></div>',icon='<i class="iconfont icon-tupian"></i>'):materialContentType.match("video.*")&&(materialHtml='<div class="video" data-src="'+materialUrl+'"><i class="iconfont icon-qidong"></i></div>',icon='<i class="iconfont icon-shipin"></i>'),'<div class="media-list-item left">        <div class="item">            <div class="label-checked-box pull-left">                <input type="checkbox" id="check-'+materialId+'" value="'+materialId+"\" data-json='"+JSON.stringify(data)+"'>                    <label for=\"check-"+materialId+'"></label>                            </div>                <div class="item-in">                    <div class="pic">                        '+materialHtml+'                        </div>                        <div class="info material-info" >                            <div class="material-info-item">'+materialOriginalName+'</div>                            <div class="material-info-item">                                <span class="iconStyle">                                    '+icon+'                                </span>                                <span class="type">'+materialContentType+'</span>                            </div>                            <div class="material-info-item">                                <span class="iconStyle">                                    <i class="iconfont icon-duochicun"></i>                                </span>                                <span class="size">'+materialSize+"</span>                            </div>                        </div>                    </div>                </div>            </div>"}function openPageInfo(){Editer_stage.tool.showLayout("page"),$(".editer-page").addClass("silde-in")}function closePageInfo(){Editer_stage.areaDataShow.hideLeftSideBar(".editer-page")}function setColorList(color){var shtml="";$(".color-list").empty();for(var i=0,len=color.length;i<len;i++){var col=color[i];shtml+='<span data-color="'+col+'" style="background: '+col+'"></span>'}$(".color-list").append(shtml)}function savePage(flag){var $li=$($("#editer-page-list li")[pargarmPageIndex]),pageJsonData=$li.attr("data-json"),pageId=Editer_stage.tool.getPageJsonData(pageJsonData,"pageId"),pageFilePath=Editer_stage.tool.getPageJsonData(pageJsonData,"pageFilePath"),pageData=editerDataStore.returnData(),pageSort=$li.index(),newPage=""===pageId,pageName=$("#page-name").val();Editer_stage.tool.showLoading("保存中..."),Public.ajaxCall({type:"POST",url:PublicUrl.programContListUrl(),data:{jsJson:JSON.stringify(pageData),pageFilePath:pageFilePath,pageId:pageId,pageName:pageName,pagePlaytime:$("#page-pauseTime").val(),programId:pargarmId,pageSort:pageSort},successCallBack:function(data){Editer_stage.tool.hideLoading();var pageId=data.response.pageId,stringJson=JSON.stringify(data.response);if(newPage?(Public.removeJs(nowPageScriptPath,"js"),$('#editer-page-list li[data-state="new"]').attr("data-pageid",pageId).attr("data-json",stringJson).removeAttr("data-state").find(".title").text(pageName),nowPageScriptPath=PublicUrl.materialResourceUrl()+data.response.pageFilePath,Public.loadJs(nowPageScriptPath,function(){serverData=picDate})):$('#editer-page-list li[data-pageid="'+pageId+'"]').attr("data-json",stringJson).find(".title").text(pageName),Editer_stage.tool.toast("保存成功！"),0===flag&&addNewPage(),-1===flag&&(window.location.href="play.html"),1===flag){var js=nowPageScriptPath.replace(/\\/g,"/"),width=Editer_stage.tool.getProgramResolutionWidth(),height=Editer_stage.tool.getProgramResolutionHeight();window.location.href="show/demo.html?js="+js+"&width="+width+"&height="+height+"&pageId="+nowPageId+"&id="+pargarmId+"&eq="+pargarmEq}}})}function controlPage(ajaxType,pageId,param,$list){var sortType=param.type;Public.ajaxCall({type:ajaxType,url:PublicUrl.programContPageUrl()+pageId,data:param,successCallBack:function(data){Editer_stage.tool.toast(data.response),"up"===sortType?Editer_stage.tool.listSortUp($list):"down"===sortType?Editer_stage.tool.listSortDown($list):(Editer_stage.tool.listSortRemove($list),setTimeout(function(){changeRemovePage()},500))}})}function changeRemovePage(){var $list=$("#editer-page-list li.active"),jsonData=JSON.parse($list.attr("data-json")),pageFilePath=PublicUrl.materialResourceUrl()+jsonData.pageFilePath,pageName=jsonData.pageName,pagePlaytime=jsonData.pagePlaytime;nowPageScriptPath!==pageFilePath&&(Public.removeJs(nowPageScriptPath,"js"),nowPageScriptPath=pageFilePath,pargarmPageIndex=$list.index(),Editer_stage.tool.setPageInfo(pageName,pagePlaytime),getJsPageInit())}function openBorderModal(){var elem=dragResize.getElemByBorder(),id=$(elem).attr("data-id"),jsonData=editerDataStore.getMediaData(id),borderSW=jsonData.borderSW,borderSpeed=jsonData.borderSpeed,borderType=jsonData.borderType,borderEffect=jsonData.borderEffect,displayBorder="none";borderSW?($("#open-off").prop("checked",!0),displayBorder="block"):($("#open-off").prop("checked",!1),displayBorder="none"),$(".border-set").css("display",displayBorder),$("#area-border-speed").val(borderSpeed),$("#area-border-effects").val(borderEffect),$("#area-border-type").val(borderType),$(".border-img").css("background-image","url(./../images/editer_border/border"+borderType+".png)"),$(".popup-border").show().addClass("silde-in")}function closeBorderModal(){var $modal=$(".popup-border");$modal.addClass("silde-out").removeClass("silde-in"),setTimeout(function(){$modal.hide().removeClass("silde-out")},300)}function addNewPage(){Editer_stage.tool.clearEditerAreaData(),serverData={mediaEle:[],pageEle:[{bgImg:"",bgColor:"",bgName:"",eqType:pargarmEq}]};var $pageList=$("#editer-page-list"),$pageLi=$pageList.find("li"),len=$pageLi.length;$pageLi.removeClass("active"),$pageList.append('<li class="active" data-state="new"><span class="title">页面</span></li>'),Editer_stage.tool.setPageInfo("页面",0),$("#page-name").attr("data-index",$pageLi.length),pargarmPageIndex=len,nowPageId=-1,pageInit()}function copyPage(){var pageId=$("#editer-page-list li.active").attr("data-pageid");pageId?Public.ajaxCall({type:"POST",url:PublicUrl.programContListUrl(),data:{pageId:pageId,_method:"PUT"},successCallBack:function(data){var response=data.response,pageName=response.pageName,pageId=response.pageId,pagePlaytime=response.pagePlaytime,pageFilePath=PublicUrl.materialResourceUrl()+response.pageFilePath;Public.removeJs(nowPageScriptPath,"js"),nowPageScriptPath=pageFilePath,$("#editer-page-list li").removeClass("active"),$("#editer-page-list").append('<li class="active" data-json=\''+JSON.stringify(response)+"' data-pageid=\""+pageId+'"><span class="title">'+pageName+"</span></li>"),pargarmPageIndex=$("#editer-page-list li.active").index(),$("#page-name").attr("data-index",pargarmPageIndex),Editer_stage.tool.setPageInfo(pageName,pagePlaytime),getJsPageInit()}}):Editer_stage.tool.toast("该页面暂未保存，请先保存！")}function valChange(obj){var $obj=$(obj),val=$obj.val();""===(val=val.replace(/^[0]+[0-9]*$/gi,1))&&(val=1),$obj.val("").val(val)}window.addEventListener("error",function(err){Editer_stage.tool.hideLoading(),"SCRIPT"===err.target.tagName&&(Editer_stage.tool.toast("当前节目不存在！"),setTimeout(function(){window.location.href="play.html"},800))},!0),$(function(){Editer_stage.tool.showLoading("页面加载..."),menu.init(),setColorList(listColor),Public.ajaxCall({type:"GET",url:PublicUrl.programContPageUrl()+pargarmId,successCallBack:function(data){var response=data.response,jsonData=JSON.parse(response.showList).showInfo,width=jsonData.programWidthPoints,height=jsonData.programHeightPoints,pageList=jsonData.pageList;if(Editer_stage.tool.setViewResolution(width,height),nowPageId)for(var i=0,len=pageList.length;i<len;i++){var pageId=pageList[i].pageId;nowPageId==pageId&&(nowPageScriptPath=PublicUrl.materialResourceUrl()+pageList[i].pageFilePath)}else nowPageScriptPath=PublicUrl.materialResourceUrl()+pageList[0].pageFilePath,nowPageId=pageList[0].pageId;Editer_stage.tool.setPageInfoList(response.showInfo.pageList),getJsPageInit()},errorCallBack:function(){}}),$(document).on("tap",".more-media",function(){clickMore()}),$(document).on("tap",".editer-list-addBtn",function(){var $this=$(this);mediaType=$this.attr("data-flag"),mediaChooseType=1,openMediaModal()}),$(document).on("tap","#choose-media-sure",function(){var checkboxArr=$("#media-list-data input[type=checkbox]:checked"),len=checkboxArr.length;if(0<len){var srcGroup=[],time=0,areaType=1*mediaType==1?1:0,addNewListsHtml="",areaTypeName=Editer_stage.tool.getMediaType(areaType),editerId=$("#editer-info-"+areaTypeName).attr("data-id");if((2===mediaChooseType||3==mediaChooseType)&&2<=len)return void Editer_stage.tool.toast("只能选择一个素材");for(var i=0;i<len;i++){var jsonData=JSON.parse($(checkboxArr[i]).attr("data-json")),srcGroupsItem=(time=jsonData.materialTime,{});srcGroupsItem.name=jsonData.materialOriginalName,srcGroupsItem.id=jsonData.materialId,srcGroupsItem.src=jsonData.materialRelativePath+jsonData.materialStorageName,srcGroupsItem.size=jsonData.materialSize,0===areaType&&(time+=srcGroupsItem.time=time),srcGroup.push(srcGroupsItem),1===mediaChooseType&&(addNewListsHtml+=Editer_stage.tool.getItemListHtml(srcGroupsItem,mediaChooseType,editerId),editerDataStore.setItemListGroupData(editerId,srcGroupsItem))}if(0===mediaChooseType)editerDataStore.addItemToData(areaType,srcGroup,1===areaType?5:time);else if(1===mediaChooseType)$("#editer-"+areaTypeName+"-list").append(addNewListsHtml);else if(2===mediaChooseType){var $list=$("#editer-"+areaTypeName+"-list li.active"),jsoData=JSON.parse($list.attr("data-json")),itemIndex=$list.attr("data-itemindex"),itemId=jsoData.id;editerDataStore.setItemListData(editerId,itemId,itemIndex,srcGroup[0]),Editer_stage.tool.setListItemData(areaTypeName,editerId,itemId,itemIndex,srcGroup)}else if(3===mediaChooseType){var param={bgImg:srcGroup[0].src,bgName:srcGroup[0].name};editerDataStore.setDataBg(param),Editer_stage.tool.setEditerAreaBg()}editerDataStore.getMediaMaxTime(),closeMediaModal()}else Editer_stage.tool.toast("请至少选择一个素材")}),$(document).on("tap","#media-search-btn",function(){pageNo=1,getMediaAjax()}),$(document).on("tap",".float-menu-item",function(){mediaType=$(this).attr("data-flag"),mediaChooseType=0,Editer_stage.tool.showLoading("数据加载..."),openMediaModal()}),$(document).on("tap",".close-media-modal",function(params){closeMediaModal()}),$(document).on("tap",".custom-overlay",function(){var type=$(this).attr("data-flag"),hideObj="";"area"===type?hideObj=".editer-area-msg":"page"===type&&(hideObj=".editer-page"),Editer_stage.tool.hideLayout(),Editer_stage.areaDataShow.hideLeftSideBar(hideObj)}),$(document).on("tap",".editer-area-list li",function(){var $this=$(this),suffix=$this.attr("data-itemsuffix");if($this.addClass("active").siblings().removeClass("active"),suffix.match(/\.(gif|png|jpe?g)$/i)){var jsonData=JSON.parse($this.attr("data-json")),src=PublicUrl.ip+PublicUrl.resources+jsonData.src,imgindex=$(this).index(),id=$($this.parents(".item")).attr("data-id");$("#controlItem_"+id).find("img").attr("src",src).attr("data-imgindex",imgindex)}}),$(document).on("tap","#editer-video-list li",function(){var jsonData=JSON.parse($(this).attr("data-json")),name=jsonData.editName?jsonData.editName:jsonData.name,id=jsonData.id,itemSuffix=$(this).attr("data-itemsuffix"),itemIndex=$(this).attr("data-itemIndex");name=name.replace(/([.][^.]+)$/,""),Editer_stage.tool.videoEditObj=$(this),$(this).addClass("active").siblings().removeClass("active"),$("input[data-flag=videoName]").attr("data-itemSuffix",itemSuffix).attr("data-itemid",id).attr("data-itemIndex",itemIndex).val(name)}),$(document).on("tap",".editer-list-editerBtn",function(){var $parents=$(this).parents(".editer-list-tool-btn");mediaType=$parents.attr("data-flag"),mediaChooseType=2,openMediaModal()}),$(document).on("tap",".editer-list-upBtn,.editer-list-downBtn,.editer-list-deleteBtn",function(){var checkedBtn=$(this).attr("data-flag"),typeName=$(this).parents(".editer-list-tool-btn").attr("data-typename"),id=$("#editer-info-"+typeName).attr("data-id"),$list=$(this).parents(".item-in-areaList").find(".editer-media-list");"up"===checkedBtn?Editer_stage.tool.listSortUp($list):"down"===checkedBtn?Editer_stage.tool.listSortDown($list):"delete"===checkedBtn&&Editer_stage.tool.listSortRemove($list),Editer_stage.tool.listSortUpData($list,id,typeName)}),$(document).on("tap",".rang-btn-big",function(){var $rangValue=$("#range-value"),value=1*$rangValue.val();500<(value+=10)?value=500:value<10&&(value=10),$rangValue.val(value),Editer_stage.tool.siderbuildEditerArea(value)}),$(document).on("tap",".rang-btn-small",function(){var $rangValue=$("#range-value"),value=1*$rangValue.val();(value-=10)<10&&(value=10),$rangValue.val(value),Editer_stage.tool.siderbuildEditerArea(value)}),$(document).on("tap","#save-page",function(){savePage()}),$(document).on("tap","#canvas-page",function(){openPageInfo()}),$(document).on("tap",".color-list span",function(){var color=$(this).attr("data-color");$("#page-color").css("background-color",color),editerDataStore.setDataBg({bgColor:color}),color=color.replace(/(#)+/,""),$("#page-color").val(color),Editer_stage.tool.setEditerAreaBg()}),$(document).on("tap",".page-bg-delete",function(){$("#page-bg").val(""),editerDataStore.setDataBg({bgImg:"",bgName:""}),Editer_stage.tool.setEditerAreaBg()}),$(document).on("tap",".page-bgCol-delete",function(){$("#page-color").val("").css("background-color",""),editerDataStore.setDataBg({bgColor:""}),Editer_stage.tool.setEditerAreaBg()}),$(document).on("tap",".page-bg-add",function(){mediaType=1,mediaChooseType=3,openMediaModal()}),$(document).on("tap",".editer-page-addBtn",function(){Editer_stage.tool.confirm("添加新页面并保存当前页面？",function(){savePage(0)})}),$(document).on("tap","#editer-page-list li",function(){$(this).addClass("active").siblings().removeClass("active")}),$(document).on("tap",".editer-page-upBtn, .editer-page-downBtn, .editer-page-deleteBtn",function(){var checkedBtn=$(this).attr("data-flag"),$list=$(this).parents(".item-in-areaList").find(".editer-media-list"),len=$list.find("li").length,pageId=$list.find("li.active").attr("data-pageid"),param={},ajaxType="POST";if("up"===checkedBtn)param.type="up";else if("down"===checkedBtn)param.type="down";else if("delete"===checkedBtn){if(len<2)return void Editer_stage.tool.toast("节目数小于2，无法删除！");param.pageId=pageId,ajaxType="DELETE"}"up"===checkedBtn||"down"===checkedBtn?(param._method="PUT",controlPage(ajaxType,pageId,param,$list)):Editer_stage.tool.confirm("确定删除？",function(){controlPage(ajaxType,pageId,param,$list)})}),$(document).on("doubleTap","#editer-page-list li",function(){var $this=$(this),clickLiIndex=$this.index(),jsonData=JSON.parse($this.attr("data-json"));pargarmPageIndex=clickLiIndex,jsonData&&nowPageId!==jsonData.pageId&&(-1===nowPageId&&$('#editer-page-list li[data-state="new"]').remove(),$("#page-name").attr("data-index",$this.index()),Public.removeJs(nowPageScriptPath),nowPageScriptPath=PublicUrl.materialResourceUrl()+jsonData.pageFilePath,Editer_stage.tool.setPageInfo($this.find(".title").text(),jsonData.pagePlaytime),nowPageId=jsonData.pageId,getJsPageInit())}),$(document).on("tap",".editer-area-tool span",function(){var flag=$(this).attr("data-flag");"fullscreen"===flag?dragResize.fullScreen():"delete"===flag?Editer_stage.tool.confirm("是否确定移除该区域？",function(){dragResize.delete()}):"lock"===flag?dragResize.lock():"unlock"===flag?dragResize.unlock():"rightalign"===flag?dragResize.alignRight():"leftalign"===flag?dragResize.alignLeft():"verticalcenter"===flag?dragResize.alignYCenter():"levelcenter"===flag?dragResize.alignXCenter():"topalign"===flag?dragResize.alignTop():"bottomalign"===flag?dragResize.alignBottom():"tobottom"===flag?dragResize.upToLast():"totop"===flag?dragResize.upToFirst():"godown"===flag?dragResize.downZindex():"goup"===flag&&dragResize.upZindex()}),$(document).on("tap","#canvas-layer",function(){openBorderModal()}),$(document).on("tap",".close-border-modal",function(){closeBorderModal()}),$(document).on("change","#open-off",function(){$(this).prop("checked")?$(".border-set").show():$(".border-set").hide()}),$(document).on("change",".popup-border input, .popup-border select",function(){var $this=$(this),flag=$this.attr("data-flag"),elem=dragResize.getElemByBorder(),id=$(elem).attr("data-id"),val=$this.val();"borderSW"===flag&&(val=$this.prop("checked")?1:0),"borderType"===flag&&$(".border-img").css("background-image","url(./../images/editer_border/border"+val+".png)"),editerDataStore.setMediaProjectData(id,flag,val),Editer_stage.tool.changeEditareaItemPrivate(flag,id)}),$(document).on("tap","#go-back",function(){Editer_stage.tool.confirm("保存当前页面？",function(){savePage(-1)})}),$(document).on("change","#page-color",function(){var val=$(this).val();editerDataStore.setDataBg({bgColor:"#"+val}),Editer_stage.tool.setEditerAreaBg()}),$(document).on("tap",".editer-page-copy",function(){copyPage()}),$(document).on("tap","#play-page",function(){savePage(1)}),$("#page-name").bind("input change",function(){var index=1*$(this).attr("data-index"),val=$(this).val();$("#editer-page-list li").eq(index).find(".title").text(val)})});